!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("@angular/common/http"),require("rxjs"),require("rxjs/operators")):"function"==typeof define&&define.amd?define("@opten/ng-jwt",["exports","@angular/core","@angular/common/http","rxjs","rxjs/operators"],t):t((e.opten=e.opten||{},e.opten["ng-jwt"]={}),e.ng.core,e.ng.common.http,e.rxjs,e.rxjs.operators)}(this,function(e,n,o,r,i){"use strict";function s(e,t){t=t||0;var n=function o(e){if(!e||null==e||!e.expiration)return null;var t=new Date(0);return t.setUTCSeconds(e.expiration),t}(e);return!n||null==n||!(n.valueOf()>(new Date).valueOf()+1e3*t)}var u=new n.InjectionToken("jwt-config"),a=function(){function e(e,t){this.config=e,this.http=t}return e.prototype.token=function(e){var t=this;return this.http.post(this.config.tokenEndpoint,e,{headers:{"Skip-Token":"true"}}).pipe(i.map(function(e){return e&&e.access_token&&t.config.setToken(e),e}))},e.prototype.get=function(){var n=this;return this.config.getToken().pipe(i.mergeMap(function(e){if(e&&s(e)){var t={grant_type:"refresh_token",refresh_token:e.refresh_token};return n.token(t)}return r.of(e)}))},e.decorators=[{type:n.Injectable}],e.ctorParameters=function(){return[{type:undefined,decorators:[{type:n.Inject,args:[u]}]},{type:o.HttpClient}]},e}(),c=function(){function e(e,t){this._config=e,this.tokenService=t,this._isRefreshingToken=!1,this._tokenSubject=new r.BehaviorSubject(null)}return e.prototype.intercept=function(t,n){var o=this,e=t.headers.has("Skip-Token"),r=t.headers["delete"]("Skip-Token");return e?n.handle(t.clone({headers:r})):!1===this._isRefreshingToken?(this._isRefreshingToken=!0,this._tokenSubject.next(null),this.tokenService.get().pipe(i.mergeMap(function(e){return o._tokenSubject.next(e),n.handle(o._addToken(t,r,e))}),i.finalize(function(){return o._isRefreshingToken=!1}))):this._tokenSubject.pipe(i.filter(function(e){return null!=e}),i.take(1),i.switchMap(function(e){return n.handle(o._addToken(t,r,e))}))},e.prototype._addToken=function(e,t,n){return n&&this._isWhitelistedHost(e.url,this._config.whitelistedDomains)?e.clone({headers:t.set(this._config.headerName,""+this._config.authScheme+n.access_token)}):e},e.prototype._isWhitelistedHost=function(e,t){var n=this,o=this._getHost(e);return-1<t.map(function(e){return n._getHost(e).toLowerCase()}).indexOf(o.toLowerCase())},e.prototype._getHost=function(e){return window.URL?new URL(e).host:e.match(/^(https?\:)\/\/(([^:\/?#]*)(?:\:([0-9]+))?)([\/]{0,1}[^?#]*)(\?[^#]*|)(#.*|)$/)[2]},e.decorators=[{type:n.Injectable}],e.ctorParameters=function(){return[{type:undefined,decorators:[{type:n.Inject,args:[u]}]},{type:a}]},e}(),t=function(){function t(e){if(e)throw new Error("JwtModule is already loaded. It should only be imported in your application's main module.")}return t.forRoot=function(e){return{ngModule:t,providers:[{provide:o.HTTP_INTERCEPTORS,useClass:c,multi:!0},{provide:u,useValue:e},a]}},t.decorators=[{type:n.NgModule}],t.ctorParameters=function(){return[{type:t,decorators:[{type:n.Optional},{type:n.SkipSelf}]}]},t}();e.isTokenExpired=s,e.JwtModule=t,e.JWT_CONFIG=u,e.TokenService=a,e.Éµa=c,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=opten-ng-jwt.umd.min.js.map